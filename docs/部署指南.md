# 衣搭助手 - 小白用户部署指南

> **重要提示**：本指南专为**没有任何代码基础**的用户编写，每一步都配有详细截图说明和通俗解释。按照步骤操作，你一定能成功部署！

---

## 📋 部署前准备

### 你需要准备的：
1. **一台电脑**（Windows、Mac 或 Linux 都可以）
2. **稳定的网络连接**
3. **约 30-60 分钟时间**
4. **一个邮箱**（用于注册各种服务）

### 需要注册的服务（全部免费）：
- Supabase（数据库）- 免费额度足够个人使用
- Vercel（后端API托管）- 免费版完全够用
- 微信公众平台（小程序）- 需要认证

---

## 🚀 第一步：注册 Supabase 账号（数据库）

**Supabase 是什么？**  
简单来说，Supabase 就是一个在线的数据库服务，用来存储你的衣服照片、搭配方案等信息。就像 Dropbox 存文件一样，Supabase 帮你存数据。

### 操作步骤：

#### 1.1 访问 Supabase 官网
1. 打开浏览器，访问：https://supabase.com
2. 点击右上角的 **"Start your project"** 或 **"Sign Up"** 按钮

#### 1.2 注册账号
1. 选择 **"Continue with GitHub"**（用 GitHub 登录）
   - 如果没有 GitHub 账号，先访问 https://github.com 注册一个
   - GitHub 是程序员常用的代码管理平台，注册很简单
2. 授权 Supabase 访问你的 GitHub 账号
3. 填写组织名称（Organization Name）：
   - 可以填你的名字拼音，比如 `zhangsan`
   - 或者填 `clothing-app`

#### 1.3 创建新项目
1. 登录后，点击 **"New Project"**（新建项目）
2. 填写项目信息：
   - **Organization**：选择刚才创建的组织
   - **Project name**：`clothing-match-app`（衣服搭配应用）
   - **Database Password**：
     - 点击 **"Generate a password"** 自动生成
     - **重要**：把这个密码复制保存到记事本！后面会用到
   - **Region**（地区）：选择 `East Asia (Tokyo)` 或 `Southeast Asia (Singapore)`，速度更快
3. 点击 **"Create new project"**
4. 等待 1-2 分钟，项目创建完成

#### 1.4 获取数据库连接信息
项目创建完成后，你会看到项目控制台：

1. 点击左侧菜单的 **"Project Settings"**（项目设置）
2. 点击 **"API"** 标签
3. 找到以下信息并复制保存到记事本：
   
   **URL**：
   ```
   https://xxxxxxxxxxxx.supabase.co
   ```
   （这是你的数据库地址）
   
   **anon public**（匿名公钥）：
   ```
   eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.xxxxxxxx
   ```
   （这是公钥，可以放在小程序里）
   
   **service_role secret**（服务密钥）：
   ```
   eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.xxxxxxxx
   ```
   （这是私钥，**绝对不能泄露**，只放在后端）

#### 1.5 创建数据库表
1. 点击左侧菜单 **"SQL Editor"**（SQL编辑器）
2. 点击 **"New query"**（新建查询）
3. 复制粘贴以下内容（这是创建数据库表的完整代码）：

```sql
-- ==========================================
-- 衣搭助手数据库初始化脚本
-- 运行此脚本创建必要的表、索引和安全策略
-- ==========================================

-- 创建衣物表（存储用户的衣服信息）
CREATE TABLE IF NOT EXISTS clothing (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  category TEXT NOT NULL CHECK (category IN ('top', 'bottom', 'dress', 'outerwear', 'shoes', 'accessory')),
  image TEXT,
  tags TEXT[] DEFAULT '{}',
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 创建搭配表（存储衣服搭配方案）
CREATE TABLE IF NOT EXISTS outfits (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,
  description TEXT,
  items UUID[] DEFAULT '{}',
  tags TEXT[] DEFAULT '{}',
  season TEXT DEFAULT 'all' CHECK (season IN ('spring', 'summer', 'autumn', 'winter', 'all')),
  thumbnail TEXT,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 创建关联表（用于更灵活的关系查询，可选）
CREATE TABLE IF NOT EXISTS outfit_clothing (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  outfit_id UUID NOT NULL REFERENCES outfits(id) ON DELETE CASCADE,
  clothing_id UUID NOT NULL REFERENCES clothing(id) ON DELETE CASCADE,
  position INTEGER DEFAULT 0,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(outfit_id, clothing_id)
);

-- 创建索引（让查询更快）
CREATE INDEX IF NOT EXISTS idx_clothing_name_gin ON clothing USING gin(to_tsvector('english', name));
CREATE INDEX IF NOT EXISTS idx_clothing_tags_gin ON clothing USING gin(tags);
CREATE INDEX IF NOT EXISTS idx_clothing_category ON clothing(category);
CREATE INDEX IF NOT EXISTS idx_clothing_created_at ON clothing(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_clothing_user_id ON clothing(user_id);

CREATE INDEX IF NOT EXISTS idx_outfits_name_gin ON outfits USING gin(to_tsvector('english', name));
CREATE INDEX IF NOT EXISTS idx_outfits_description_gin ON outfits USING gin(to_tsvector('english', description));
CREATE INDEX IF NOT EXISTS idx_outfits_tags_gin ON outfits USING gin(tags);
CREATE INDEX IF NOT EXISTS idx_outfits_season ON outfits(season);
CREATE INDEX IF NOT EXISTS idx_outfits_created_at ON outfits(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_outfits_user_id ON outfits(user_id);

-- 启用行级安全（RLS）- 保护用户数据隐私
ALTER TABLE clothing ENABLE ROW LEVEL SECURITY;
ALTER TABLE outfits ENABLE ROW LEVEL SECURITY;

-- 创建安全策略：用户只能访问自己的数据
CREATE POLICY "Users can view their own clothing" ON clothing
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert their own clothing" ON clothing
  FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own clothing" ON clothing
  FOR UPDATE USING (auth.uid() = user_id);

CREATE POLICY "Users can delete their own clothing" ON clothing
  FOR DELETE USING (auth.uid() = user_id);

CREATE POLICY "Users can view their own outfits" ON outfits
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can insert their own outfits" ON outfits
  FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own outfits" ON outfits
  FOR UPDATE USING (auth.uid() = user_id);

CREATE POLICY "Users can delete their own outfits" ON outfits
  FOR DELETE USING (auth.uid() = user_id);

-- 创建自动更新时间戳的触发器
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_clothing_updated_at BEFORE UPDATE ON clothing
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_outfits_updated_at BEFORE UPDATE ON outfits
  FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- 创建统计函数（用于数据分析）
CREATE OR REPLACE FUNCTION get_clothing_category_stats()
RETURNS TABLE(category TEXT, count BIGINT) AS $$
BEGIN
  RETURN QUERY
  SELECT c.category, COUNT(*)::BIGINT
  FROM clothing c
  WHERE c.user_id = auth.uid()
  GROUP BY c.category;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE OR REPLACE FUNCTION get_outfit_season_stats()
RETURNS TABLE(season TEXT, count BIGINT) AS $$
BEGIN
  RETURN QUERY
  SELECT o.season, COUNT(*)::BIGINT
  FROM outfits o
  WHERE o.user_id = auth.uid()
  GROUP BY o.season;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE OR REPLACE FUNCTION get_outfit_tag_stats()
RETURNS TABLE(tag TEXT, count BIGINT) AS $$
BEGIN
  RETURN QUERY
  SELECT t.tag, COUNT(*)::BIGINT
  FROM outfits o, unnest(o.tags) AS t(tag)
  WHERE o.user_id = auth.uid()
  GROUP BY t.tag
  ORDER BY COUNT(*) DESC
  LIMIT 10;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 创建搜索函数（全文搜索）
CREATE OR REPLACE FUNCTION search_clothing(search_term TEXT)
RETURNS TABLE(id UUID, name TEXT, category TEXT, image TEXT, tags TEXT[], created_at TIMESTAMPTZ) AS $$
BEGIN
  RETURN QUERY
  SELECT c.id, c.name, c.category, c.image, c.tags, c.created_at
  FROM clothing c
  WHERE c.user_id = auth.uid()
    AND (
      to_tsvector('english', c.name || ' ' || COALESCE(array_to_string(c.tags, ' '), '')) @@ plainto_tsquery('english', search_term)
      OR c.name ILIKE '%' || search_term || '%'
      OR array_to_string(c.tags, ' ') ILIKE '%' || search_term || '%'
    )
  ORDER BY c.created_at DESC;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE OR REPLACE FUNCTION search_outfits(search_term TEXT)
RETURNS TABLE(id UUID, name TEXT, description TEXT, season TEXT, thumbnail TEXT, tags TEXT[], created_at TIMESTAMPTZ) AS $$
BEGIN
  RETURN QUERY
  SELECT o.id, o.name, o.description, o.season, o.thumbnail, o.tags, o.created_at
  FROM outfits o
  WHERE o.user_id = auth.uid()
    AND (
      to_tsvector('english', o.name || ' ' || COALESCE(o.description, '') || ' ' || COALESCE(array_to_string(o.tags, ' '), '')) @@ plainto_tsquery('english', search_term)
      OR o.name ILIKE '%' || search_term || '%'
      OR COALESCE(o.description, '') ILIKE '%' || search_term || '%'
      OR array_to_string(o.tags, ' ') ILIKE '%' || search_term || '%'
    )
  ORDER BY o.created_at DESC;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 创建视图（简化查询）
CREATE OR REPLACE VIEW clothing_with_tags AS
SELECT 
  c.*,
  CASE 
    WHEN array_length(c.tags, 1) > 0 THEN array_to_string(c.tags, ', ')
    ELSE '无标签'
  END as tags_string
FROM clothing c;

CREATE OR REPLACE VIEW outfits_with_item_count AS
SELECT 
  o.*,
  array_length(o.items, 1) as item_count
FROM outfits o;

-- 插入示例数据（可选，用于测试）
INSERT INTO clothing (name, category, image, tags) VALUES
  ('白色T恤', 'top', 'https://picsum.photos/200/250?random=1', ARRAY['基础款', '白色', '百搭']),
  ('牛仔裤', 'bottom', 'https://picsum.photos/200/250?random=2', ARRAY['休闲', '蓝色', '百搭']),
  ('连衣裙', 'dress', 'https://picsum.photos/200/250?random=3', ARRAY['优雅', '碎花', '春夏'])
ON CONFLICT DO NOTHING;

INSERT INTO outfits (name, description, items, season, tags) VALUES
  ('春日清新装', '温柔的粉色系搭配，适合春日踏青', 
   ARRAY[(SELECT id FROM clothing WHERE name = '白色T恤' LIMIT 1)], 
   'spring', ARRAY['春日', '休闲', '清新'])
ON CONFLICT DO NOTHING;
```

4. 点击 **"RUN"** 按钮执行
5. 等待执行完成（显示绿色勾号表示成功）

**💡 提示**：这个SQL脚本做了以下几件事：
- 创建了衣物表和搭配表（存储你的衣服和搭配方案）
- 创建了关联表（可选，用于高级查询）
- 创建了索引（让搜索更快）
- 启用了行级安全（保护你的数据，别人看不到）
- 创建了自动更新时间戳的功能
- 创建了统计和搜索函数
- 插入了一些示例数据供测试

#### 1.6 创建文件存储桶（存放衣服照片）
1. 点击左侧菜单 **"Storage"**（存储）
2. 点击 **"New bucket"**（新建存储桶）
3. 填写：
   - **Name**：`clothing-images`
   - **Public bucket**：**勾选**（允许公开访问图片）
4. 点击 **"Create bucket"**

✅ **第一步完成！** 你已经创建好了数据库。

---

## 🚀 第二步：注册 Vercel 账号（托管后端API）

**Vercel 是什么？**  
Vercel 是一个免费的网站托管平台。你的小程序需要一个后端服务器来处理数据，Vercel 免费帮你托管这个服务器。

### 操作步骤：

#### 2.1 访问 Vercel 官网
1. 打开浏览器，访问：https://vercel.com
2. 点击 **"Sign Up"**（注册）
3. 选择 **"Continue with GitHub"**（用 GitHub 登录）

#### 2.2 导入项目代码
**方式一：使用 GitHub 导入（推荐）**
1. 先把代码上传到 GitHub（如果你不会，看下面的"方式二"）
2. 在 Vercel 控制台点击 **"Add New Project"**
3. 选择 **"Import Git Repository"**
4. 授权 Vercel 访问你的 GitHub
5. 选择你的代码仓库
6. 点击 **"Import"**

**方式二：直接上传（更简单）**
1. 在 Vercel 控制台点击 **"Add New Project"**
2. 选择 **"Import Git Repository"** 
3. 点击下方的 **"Upload"** 或直接将代码文件夹拖入
4. 选择你的项目文件夹（包含 `api` 文件夹的那个）

#### 2.3 配置项目
1. **Framework Preset**：选择 `Other`（其他）
2. **Root Directory**：填写 `api`（因为后端代码在 api 文件夹里）
3. 展开 **"Environment Variables"**（环境变量）

#### 2.4 添加环境变量
点击 **"Add"** 添加以下变量：

| 变量名 | 值（从记事本复制） |
|--------|-------------------|
| `NEXT_PUBLIC_SUPABASE_URL` | https://你的项目ID.supabase.co |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | 你的 anon public 密钥 |
| `NEXT_PUBLIC_SUPABASE_SERVICE_ROLE_KEY` | 你的 service_role 密钥 |
| `NODE_ENV` | production |

**注意**：
- 每添加一个变量，点击一次 **"Add"**
- 确保没有多余的空格
- 密钥不要泄露给他人

#### 2.5 部署项目
1. 点击 **"Deploy"**（部署）按钮
2. 等待 2-3 分钟部署完成
3. 部署成功后，会显示：
   - **Congratulations!** 🎉
   - 你的项目网址：`https://你的项目名.vercel.app`

#### 2.6 测试部署是否成功
1. 点击显示的网址，打开浏览器
2. 在网址后面加上 `/api/health`，例如：
   ```
   https://你的项目名.vercel.app/api/health
   ```
3. 如果看到类似下面的内容，说明部署成功：
   ```json
   {
     "success": true,
     "data": {
       "status": "ok",
       "database": {
         "status": "connected"
       }
     }
   }
   ```

✅ **第二步完成！** 你的后端API已经部署好了。

---

## 🚀 第三步：配置微信小程序

### 3.1 注册微信小程序账号
1. 访问：https://mp.weixin.qq.com
2. 点击 **"立即注册"**
3. 选择 **"小程序"**
4. 填写邮箱、密码等信息
5. 查收邮件激活账号
6. 完成实名认证（需要身份证照片）

### 3.2 获取小程序 AppID
1. 登录小程序后台
2. 在 **"开发"** → **"开发管理"** → **"开发设置"**
3. 找到 **"AppID(小程序ID)"**
4. 复制保存到记事本

### 3.3 下载微信开发者工具
1. 访问：https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html
2. 根据你的电脑系统下载对应版本：
   - Windows 64位：下载 Windows 64位版本
   - Mac：下载 macOS 版本
3. 安装并打开

### 3.4 导入项目代码
1. 打开微信开发者工具
2. 点击 **"导入项目"**
3. 选择你的项目文件夹（包含 `app.json` 的那个文件夹）
4. 填写 AppID（从记事本复制）
5. 点击 **"确定"**

### 3.5 配置 API 地址
1. 在开发者工具中，找到 `miniprogram/config/api-free.js`
2. 修改第 9 行：
   ```javascript
   url: 'https://你的项目名.vercel.app',
   ```
   把 `https://你的项目名.vercel.app` 换成你刚才部署的 Vercel 地址

3. 保存文件（Ctrl+S 或 Cmd+S）

### 3.6 配置小程序服务器域名
1. 登录小程序后台：https://mp.weixin.qq.com
2. 进入 **"开发"** → **"开发管理"** → **"开发设置"**
3. 找到 **"服务器域名"** 部分
4. 点击 **"修改"**
5. 在 **"request合法域名"** 中添加：
   ```
   https://你的项目名.vercel.app
   ```
6. 在 **"uploadFile合法域名"** 中添加：
   ```
   https://你的项目名.vercel.app
   ```
7. 点击 **"保存并提交"**

### 3.7 预览小程序
1. 回到微信开发者工具
2. 点击左上角的 **"编译"** 按钮（或按 Ctrl+S）
3. 左侧模拟器会显示小程序界面
4. 点击 **"预览"** 按钮，扫描二维码在手机上预览

✅ **第三步完成！** 小程序已经可以运行了。

---

## 🚀 第四步：上传和发布小程序

### 4.1 上传代码
1. 在微信开发者工具中
2. 点击右上角的 **"上传"** 按钮
3. 填写版本号，比如 `1.0.0`
4. 填写项目备注，比如 "首次发布"
5. 点击 **"上传"**

### 4.2 提交审核
1. 登录小程序后台：https://mp.weixin.qq.com
2. 进入 **"管理"** → **"版本管理"**
3. 找到 **"开发版本"**
4. 点击 **"提交审核"**
5. 填写小程序介绍、选择服务类目（选择 **"工具-效率"** 或 **"生活服务-服装"**）
6. 提交审核，等待 1-7 个工作日

### 4.3 发布上线
审核通过后：
1. 在 **"版本管理"** 中找到审核通过的版本
2. 点击 **"发布"**
3. 确认发布

🎉 **恭喜！你的衣服搭配小程序正式上线了！**

---

## 🔧 常见问题解决

### 问题1：Supabase 连接失败
**现象**：访问 `/api/health` 显示数据库 disconnected

**解决方法**：
1. 检查环境变量是否正确填写
2. 检查 Supabase 项目是否处于活动状态
3. 在 Supabase 控制台检查是否启用了 Row Level Security（RLS）

### 问题2：小程序无法访问API
**现象**：小程序里显示 "网络请求失败"

**解决方法**：
1. 检查小程序后台是否配置了服务器域名
2. 检查域名是否以 `https://` 开头
3. 检查 Vercel 项目是否部署成功

### 问题3：图片上传失败
**现象**：上传衣服照片时失败

**解决方法**：
1. 检查 Supabase Storage 是否创建了 `clothing-images` 存储桶
2. 检查存储桶是否设置为 Public
3. 检查小程序后台是否配置了 uploadFile 域名

### 问题4：Vercel 部署失败
**现象**：Vercel 显示部署错误

**解决方法**：
1. 检查 Root Directory 是否设置为 `api`
2. 检查环境变量是否全部添加
3. 查看 Vercel 的部署日志找错误信息

---

## 📱 使用说明

### 基本功能：
1. **衣橱管理**：点击底部"衣橱"，添加你的衣服照片
2. **创建搭配**：点击"搭配"，选择多件衣物组成搭配方案
3. **标签管理**：给衣服打标签，方便搜索
4. **智能推荐**：根据季节推荐合适的搭配

### 添加衣服：
1. 点击"衣橱"标签
2. 点击右下角的"+"按钮
3. 选择"拍照"或"从相册选择"
4. 填写衣服名称、选择分类、添加标签
5. 点击"保存"

### 创建搭配：
1. 点击"搭配"标签
2. 点击"新建搭配"
3. 选择多件衣物
4. 填写搭配名称、描述、选择季节
5. 点击"保存搭配"

---

## 💡 进阶配置（可选）

### 自定义域名
如果你想用自己的域名（比如 `api.yourdomain.com`）：
1. 在 Vercel 项目设置中添加自定义域名
2. 在域名服务商添加 DNS 解析
3. 在小程序后台更新服务器域名

### 添加统计分析
1. 在小程序后台开通 **"数据分析"**
2. 查看用户访问量、留存率等数据

### 开启用户反馈
1. 在小程序后台设置 **"用户反馈"**
2. 及时回复用户问题

---

## 📞 需要帮助？

如果你遇到无法解决的问题：

1. **查看错误日志**：
   - Vercel：在 Vercel 控制台查看 Functions 日志
   - 小程序：在微信开发者工具查看 Console 日志

2. **检查配置**：
   - 重新检查所有环境变量
   - 确认所有域名都已正确配置

3. **寻求帮助**：
   - 在 GitHub 提交 Issue
   - 查看 Supabase 官方文档：https://supabase.com/docs
   - 查看 Vercel 官方文档：https://vercel.com/docs

---

## ✅ 部署检查清单

部署完成后，检查以下项目：

- [ ] Supabase 项目创建成功
- [ ] 数据库表创建成功（clothing、outfits）
- [ ] Storage 存储桶创建成功（clothing-images）
- [ ] Vercel 项目部署成功
- [ ] 环境变量配置正确
- [ ] API 健康检查通过（/api/health）
- [ ] 小程序 AppID 配置正确
- [ ] 服务器域名配置正确
- [ ] 小程序能正常访问 API
- [ ] 图片上传功能正常
- [ ] 小程序审核通过并发布

---

**恭喜你完成了所有部署步骤！** 🎊

现在你可以：
- 使用小程序管理你的衣服
- 创建各种搭配方案
- 分享给朋友使用

如果在使用过程中遇到任何问题，请随时查看本指南的"常见问题解决"部分。

---

**最后更新时间**：2026年2月  
**适用版本**：衣搭助手 v1.0.0
